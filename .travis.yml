language: objective-c
osx_image: xcode8
sudo: false
env:
  - PLATFORM=Mac
  - PLATFORM=iOS NAME='iPhone SE'
  - PLATFORM=tvOS NAME='Apple TV 1080p'
  - PLATFORM=watchOS

before_install:
  - if [ -n "$NAME" ]; then
      export UUID=$(instruments -s | ruby -e "ARGF.each_line{ |ln| ln =~ /$NAME .* \[(.*)\]/; if \$1; puts(\$1); exit; end }");
    fi
  - brew update
  - if brew list | grep -q carthage; then
      echo Carthage installed. Proceed without installing;
      carthage version;
    else
      echo Carthage not installed. Installing using homebrew;
      brew install carthage;
    fi
  - gem install xcpretty --no-document
script:
  - xcodebuild -version
  - set -o pipefail;
    case $PLATFORM in
    Mac)
      xcodebuild -scheme PusherPlatform -enableCodeCoverage YES test | xcpretty;;
    iOS|tvOS)
      open -a "simulator" --args -CurrentDeviceUDID "$UUID"
      xcodebuild -scheme PusherPlatform -destination "id=$UUID" -enableCodeCoverage YES test | xcpretty;;
    watchOS)
      xcodebuild -scheme PusherPlatform -destination "name=Apple Watch - 38mm" | xcpretty;;
    esac
before_deploy:
  - carthage build --no-skip-current --project-directory PusherPlatform
  - carthage archive PusherPlatform --project-directory PusherPlatform
deploy:
  provider: releases
  api_key:
    secure: Ks0s+QxWr/PpUTSpQPXDsw7KKNWUrdhLG8qs1t9CGEry7j+tFaFIHACkNyxMqISnClsFAWCIhAqqAYS6k0z656j0gn08i87QU7s5Tsr8Zj2nrjAGQ/oOx/T+MVL+1q2poTPKLf18RGTC9ADxlpaXSO2Uk+OyFfhMMlRTdguX5oSpGyoIoL1VrIIy/flEujIOEIN0fACaMhgJ5eHK+dRv9UVtfc37nNLJkN617NSvSHCccydfsom9sdLGiuhReE/DQhWMUf3caYne6ywfGSKEBZWvTJK5ukch+5n3UqnzCaIl1cmbu9HQIufDuYSxYrYmV2FSeC+nR1/C5lXNhpYBT0BOSYySH+XmB5taK5KcBYBRo9MYCG6XUQRxJZ3N+b8WlFrHrNDjyFzvQ/1sa+t6j34Cba7Jj+N683nltUOJhW8gmIbDw9qu4F4PzNtOzKPcaY1tkRPBFlzDOIHxpjxqva2IBpW9woUGuzh7/FcbWxv915EMo3variFhGPhwkjNza3wIkiNrDQHWShzHJSeveHi5OhbVvVMqFkC/jN7z5ftyWzveM2r7vAtVjdpkFZovZ3tTuQfA8WBwmD0BE2vCl58F1r8xtg97Y0l2ZEF3BJyttK0y6eITpMR41GAVp8Ngna/UvlXmbXY5g71vst99uNcdA9eXq0Fase2HfUObfdA=
  file: PusherPlatform.framework.zip
  skip_cleanup: true
  on:
    repo: pusher/pusher-platform-swift
    tags: true
after_success:
  - sleep 5
